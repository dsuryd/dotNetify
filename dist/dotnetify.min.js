var dotnetify="undefined"==typeof dotnetify?{}:dotnetify,dotNetify={};!function(a){"function"==typeof define&&define.amd?define(["jquery","knockout","ko-mapping","jquery-ui","signalr","signalr-hub"],a):"object"==typeof exports&&"object"==typeof module?module.exports=a(require("jquery"),require("knockout"),require("ko-mapping"),require("jquery-ui"),require("signalr"),require("signalr-hub")):a(jQuery,ko,ko.mapping)}(function(a,b,c){return b.mapping=c,dotnetify=a.extend(dotnetify,{version:"1.1.0",hub:null,debug:!1,debugFn:null,offline:!1,isOffline:!1,offlineTimeout:5e3,offlineCacheFn:null,init:function(){var b=function(){a.each(a("[data-vm]"),function(){a(this).dotnetify()})};if(null===dotnetify.hub){var c=a.connection.dotNetifyHub;c.client.response_VM=function(b,d){if("403"==d)return void console.error("Unauthorized access to "+b);var e=b,f=null;if(e.indexOf("$")>=0){var g=b.split("$");e=g[0],f=g[1]}var h="[data-vm='"+e+"']",g=e.split(".");if(g.length>1){for(h="",i=0;i<g.length-1;i++)h+="[data-master-vm='"+g[i]+"'] ";h+="[data-vm='"+g[i]+"']"}null!=f&&(h+="[data-vm-id='"+f+"']");var j=a(h);j.length>0?j.data("ko-dotnetify").UpdateVM(d):c.server.dispose_VM(b)};var d=function(){var c="undefined"==typeof dotnetify.hubOptions?a.connection.hub.start():a.connection.hub.start(dotnetify.hubOptions);return c.done(function(){dotnetify._connectRetry=0,b()}).fail(function(a){console.error(a)}),setTimeout(function(){!dotnetify.offline||dotnetify.isOffline||dotnetify.isConnected()||(b(),dotnetify.isOffline=!0,a(document).trigger("offline",dotnetify.isOffline))},dotnetify.offlineTimeout),c};dotnetify.hub=d(),a.connection.hub.disconnected(function(){setTimeout(function(){dotnetify.hub=d()},5e3*dotnetify._connectRetry+500),dotnetify._connectRetry<3&&dotnetify._connectRetry++}),a.connection.hub.stateChanged(function(b){var c={0:"connecting",1:"connected",2:"reconnecting",4:"disconnected"};console.log("SignalR: "+c[b.newState]);var d=1!=b.newState;dotnetify.isOffline!=d&&(dotnetify.isOffline=d,a(document).trigger("offline",dotnetify.isOffline))})}else dotnetify.isConnected()?dotnetify.hub.done(b):dotnetify.offline&&b()},isConnected:function(){return a.connection.hub.state==a.signalR.connectionState.connected},widget:function(b){return a(b).data("ko-dotnetify")},plugins:{},_connectRetry:0}),dotNetify=dotnetify,a(function(){dotnetify.init()}),a.widget("ko.dotnetify",{_create:function(){var b=this;b.VMType=b.element.attr("data-vm"),b.VMId=b.VMType,b.Hub=a.connection.dotNetifyHub;var c=b.element.attr("data-vm-id");null!=c&&(b.VMId+="$"+c),a.each(b.element.parents("[data-master-vm]"),function(){b.VMId=a(this).attr("data-master-vm")+"."+b.VMId}),dotnetify.offline&&b._ListenToOfflineEvent(),null!=b.VMId?dotnetify.isConnected()?b._RequestVM():dotnetify.offline&&b._GetOfflineVM():console.error("ERROR: dotnetify - failed to find 'data-vm' attribute in the element where .dotnetify() was applied.")},_destroy:function(){try{var b=this;"function"==typeof b.OfflineFn&&a(document).off("offline",b.OfflineFn),a.each(dotnetify.plugins,function(a,c){"function"==typeof c.$destroy&&c.$destroy.apply(b.VM)}),null!=b.VM&&b.VM.hasOwnProperty("$destroy")&&b.VM.$destroy()}catch(a){console.error(a.stack)}this.Hub.server.dispose_VM(b.VMId)},UpdateVM:function(c){var d=this;try{if(null==d.VM){d.VM=b.mapping.fromJS(JSON.parse(c)),d.VM.$vmId=d.VMId,d.VM.$element=d.element,dotnetify.offline&&(d.VM.$vmOffline=b.observable(d.IsOffline)),this._AddBuiltInFunctions(),a.each(dotnetify.plugins,function(a,b){"function"==typeof b.$init&&b.$init.apply(d.VM)}),"function"==typeof d.VM.$init&&d.VM.$init();try{b.applyBindings(d.VM,d.element[0])}catch(a){console.error(a.stack)}d.VM.$serverUpdate=!0,d._OnComponentReady(function(){a.each(dotnetify.plugins,function(a,b){"function"==typeof b.$ready&&b.$ready.apply(d.VM)}),d._SubscribeObservables(d.VM),"function"==typeof d.VM.$ready&&d.VM.$ready(),d.element.trigger("ready",{VMId:d.VMId,VM:d.VM})}),dotnetify.offline&&dotnetify.isConnected()&&"function"==typeof dotnetify.offlineCacheFn&&dotnetify.offlineCacheFn(d.VMId+d.element.attr("data-vm-arg"),c)}else{d.VM.$serverUpdate=!1;var e=JSON.parse(c);d._PreProcess(e);try{b.mapping.fromJS(e,d.VM)}catch(a){console.error(a.stack)}d.VM.$serverUpdate=!0,d._OnComponentReady(function(){d._SubscribeObservables(d.VM)})}}catch(a){console.error(a.stack)}dotnetify.debug&&(console.log("["+d.VMId+"] received> "),console.log(JSON.parse(c)),null!=dotnetify.debugFn&&dotnetify.debugFn(d.VMId,"received",JSON.parse(c)))},_AddBuiltInFunctions:function(){var c=this;c.VM.$preventBinding=function(a){c.VM.$serverUpdate=!1,a.apply(c.VM),c.VM.$serverUpdate=!0},c.VM.$addList=function(a,c){var d=b.mapping.fromJS(c),e=a().$vmKey;if(null!=e){var f=b.utils.arrayFirst(a(),function(a){return a[e]()==d[e]()});if(null!=f)return void a.replace(f,d)}a.push(d)},c.VM.$updateList=function(a,c){var d=b.mapping.fromJS(c),e=a().$vmKey;if(null!=e){if(!d.hasOwnProperty(e))return void console.error("ERROR: object requires property '"+e+"'");var f=b.utils.arrayFirst(a(),function(a){return a[e]()==d[e]()});if(null!=f){for(prop in d)b.isObservable(d[prop])&&f[prop](d[prop]());return}}a.push(d)},c.VM.$removeList=function(a,b){c.VM.$preventBinding(function(){a.remove(b)})},c.VM.$on=function(a,b){a.subscribe(function(a){b(a)})},c.VM.$once=function(a,b){var c=a.subscribe(function(a){c.dispose(),b(a)})},c.VM.$loadView=function(b,c,d,e,f){return"object"==typeof d&&null!=d?(f=e,e=d,d=null):"function"==typeof d?(f=d,d=null):"function"==typeof e&&(f=e,e=null),null==c||""==c?void a(b).empty():void a(b).load(c,null,function(){null==e||a.isEmptyObject(e)||a(this).attr("data-vm-arg",JSON.stringify(e)),"function"==typeof f&&f.apply(this),null!=d?a.getScript(d,function(){dotnetify.init()}):dotnetify.init()})},c.VM.$inject=function(d,e){b.isObservable(d)&&"push"in d?a.each(d(),function(a,b){c._Inject(b,e)}):c._Inject(d,e)};var d=window[c.VMType];null!=d&&("function"==typeof d&&(d=new d),c._Inject(c.VM,d)),a.each(dotnetify.plugins,function(a,b){b.hasOwnProperty("$inject")&&b.$inject(c.VM)})},_GetOfflineVM:function(){var a=this;if("function"==typeof dotnetify.offlineCacheFn){var b=dotnetify.offlineCacheFn(a.VMId+a.element.attr("data-vm-arg"));null==b&&(b=dotnetify.offlineCacheFn(a.VMId)),null!=b&&(dotnetify.debug&&console.warn("["+a.VMId+"] using offline data"),a.IsOffline=!0,a.UpdateVM(b))}},_ListenToOfflineEvent:function(){var b=this;b.IsOffline=!1,b.OfflineFn=function(a,c){null!=b.VM&&b.VM.hasOwnProperty("$vmOffline")&&b.VM.$vmOffline(c),b.IsOffline=c,c?null==b.VM&&b._GetOfflineVM():b._RequestVM()},a(document).one("offline",b.OfflineFn.bind(b))},_Inject:function(a,c){for(prop in c)a.hasOwnProperty(prop)||("function"==typeof c[prop]?0==prop.indexOf("_")?a[prop]=b.pureComputed(c[prop],a):a[prop]=c[prop]:0==prop.indexOf("_")&&(a[prop]=b.observable(c[prop]),a[prop].$subscribe=!0))},_OnComponentReady:function(b){var c=this,d=0,e=function(){var f=!0,g=c.element.find("[params]");g.length>0&&(f=0==a.grep(g,function(a){return 0==a.childElementCount}).length),f||d++>3?b():setTimeout(e,250)};e()},_OnValueChanged:function(b,c){var d={};if(d[b]=c instanceof Object?a.extend({},c):c,dotnetify.isConnected())try{this.Hub.server.update_VM(this.VMId,d),dotnetify.debug&&(console.log("["+this.VMId+"] sent> "),console.log(d),null!=dotnetify.debugFn&&dotnetify.debugFn(this.VMId,"sent",d))}catch(a){console.error(a)}},_PreProcess:function(a){for(var b in a){var c=/(.*)_add/.exec(b);if(null==c){var c=/(.*)_update/.exec(b);if(null==c){var c=/(.*)_remove/.exec(b);if(null==c);else{var d=this.VM[c[1]];if(null==d)throw new Error("unable to resolve "+b);var e=d().$vmKey;if(null==e)throw new Error("unable to resolve "+b+" due to missing vmItemKey attribute");this.VM.$removeList(this.VM[c[1]],function(c){return c[e]()==a[b]}),delete a[b]}}else{var d=this.VM[c[1]];if(null==d)throw new Error("unable to resolve "+b);this.VM.$updateList(d,a[b]),delete a[b]}}else{var d=this.VM[c[1]];if(null==d)throw new Error("unable to resolve "+b);this.VM.$addList(d,a[b]),delete a[b]}}},_RequestVM:function(){var b=this,c=b.element.attr("data-vm-arg");if(c=null!=c?a.parseJSON(c.replace(/'/g,'"')):null,dotnetify.isConnected())try{b.Hub.server.request_VM(b.VMId,c)}catch(a){console.error(a)}},_SubscribeObservables:function(a,c){var d=this;if(null!=a)if(b.isObservable(a))"$subscribe"in a==!1&&(a.subscribe(function(a){d.VM.$serverUpdate===!0&&d._OnValueChanged(c,a)}),a.$subscribe=!0),this._SubscribeObservables(a(),c);else if("object"==typeof a){var e="$vmKey"in a?a.$vmKey:null;for(property in a)"$"!=property.charAt(0)&&"_"!=property.charAt(0)&&(path=null!=e?"$"+a[property][e]():property,this._SubscribeObservables(a[property],null==c?path:c+"."+path))}else if(a instanceof Array)for(index in a)path="$"+index,this._SubscribeObservables(a[index],null==c?path:c+"."+path)}}),b.bindingHandlers.vmItemKey={preprocess:function(a){return"'"!=a.charAt(0)?"'"+a+"'":a},update:function(a,c,d,e,f){var g=c(),h=d.get("foreach");!b.isObservable(h)&&h.hasOwnProperty("data")&&(h=h.data),b.isObservable(h)&&null!=h()&&null!=g&&(h().$vmKey=g)}},b.bindingHandlers.vmCommand={init:function(a,c,d,e,f){var g=f.$root,h=null,i=null,j=/return\s{(.*):(.*)}\s/.exec(c.toString());if(null!=j)h=j[1].trim(),i=j[2].trim();else{var k=/return\s(.*)\s/.exec(c.toString());null!=k&&(h=k[1].trim())}if(null==h)throw new Error("invalid vmCommand value at "+a.outerHTML);var l=function(){return null!=g[h]?g[h]:c()};null!=i?"'"==i.charAt(0)?i=i.replace(/(^'|'$)/g,""):b.isObservable(e[i])?i=b.unwrap(e[i]):"$data"==i&&(i=e):i=!0;var m=function(){return function(){var c=l();b.isObservable(c)?(g.$preventBinding(function(){c(i!==!0&&null)}),c(i)):c.apply(g,[e,a,f.$parent])}};b.bindingHandlers.click.init(a,m,d,e,f)}},b.bindingHandlers.vmOnce={init:function(a,c,d,e,f){b.bindingHandlers.vmOn.init(a,c,d,e,f,!0)}},b.bindingHandlers.vmOn={init:function(a,c,d,e,f,g){var h=f.$root,i=null,j=null,k=c.toString(),l=/return\s{(.*):(.*)}\s/.exec(k);if(null!=l&&(i=l[1].trim(),j=l[2].trim()),null==j)throw new Error("invalid vmOn function at "+a.outerHTML);var m=function(){return null!=h[j]?h[j]:c()[i]};if(null!=i&&!b.isObservable(e[i]))throw new Error("invalid vmOn data: "+c());m().apply(h,[e,a,f.$parent]),null==g&&e[i].subscribe(function(b){m().apply(h,[e,a,f.$parent])})}},dotnetify});