{"componentChunkName":"component---src-templates-blog-post-js","path":"/aws-integration/","result":{"data":{"site":{"siteMetadata":{"title":"dotNetify"}},"markdownRemark":{"id":"b80f3eee-158c-5c89-95a0-a408f7b3e03d","excerpt":"If you’re a dotNetify user, you might be interested to know that the AWS WebSocket API integration capability was just added to the framework early this year…","html":"<p>If you’re a <a href=\"https://dotnetify.net\">dotNetify</a> user, you might be interested to know that the AWS WebSocket API integration capability was just added to the framework early this year. By default, dotNetify uses SignalR for client-server communication, but with this update, it can also use the browser’s native WebSocket API to communicate with other WebSocket server implementations, such as Amazon API Gateway.</p>\n<p>Amazon API Gateway is a great option for scaling out. It is a fully-managed service that maintains persistent connections and handles the message transfer between the clients and your application server through built-in HTTP integration endpoints. With Amazon API Gateway, you won’t have to worry about self-hosting a web server that can handle large-scale WebSocket connections.</p>\n<img src=\"/dotNetify/df70d5064690d977ada2a196def88337/diagram.svg\" width=\"630px\" style=\"margin-bottom:2rem\">\n<p>So, how can you get your dotNetify application communicating through Amazon API Gateway? Well, the first thing you need to do is create, configure, and deploy a WebSocket API on Amazon API Gateway. You’ll also need to create an IAM authorization for allowing access to the API, and configure the HTTP integration endpoints and the IAM credentials on the dotNetify app server. Lastly, you’ll need to point the dotNetify client to the API’s WebSocket URL.</p>\n<h2>Amazon WebSocket API</h2>\n<p>Setting up a WebSocket API in AWS involves many steps if you do it manually. To make things easier, <a href=\"https://github.com/dsuryd/dotNetify/blob/master/dotnetify-cloudformation-template.yaml\">a CloudFormation template</a> is provided to define an ApiGatewayV2 API of WebSocket protocol type, the routes and integration contracts with dotNetify HTTP endpoints. All you need to do is copy and edit the template to replace <code class=\"language-text\">&lt;your-domain-url&gt;</code> with the domain name of your deployed dotNetify app server.</p>\n<p>After the API has been created, go to the API Gateway service and deploy it. Notice the two URLs that are provided on the Deployment Stage page: the <em>WebSocket URL</em> and the <em>Connection URL</em>. Use the <a href=\"https://github.com/websockets/wscat\">wscat</a> tool to verify the WebSocket URL is accepting connections.</p>\n<p>Next, create an IAM user with sufficient permission for the dotNetify server to call the Connection URL so it can push data to clients. You can use an AWS policy <code class=\"language-text\">AmazonAPIGatewayInvokeFullAccess</code> for this. Once it’s created, generate an access key for our next step.</p>\n<h2>DotNetify App Server</h2>\n<p>Now, let’s configure the dotNetify app server to enable the integration endpoints and set the IAM access key. To sign the HTTP requests with the AWS signature, we’ll use a NuGet package called <a href=\"https://www.nuget.org/packages/AwsSignatureVersion4\">AwsSignatureVersion4</a>. We’ll also need to configure the startup class, which is pretty straightforward.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Amazon<span class=\"token punctuation\">.</span>Runtime</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">AwsSignatureVersion4</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">DotNetify</span><span class=\"token punctuation\">;</span>\n<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n  <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> awsCredentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ImmutableCredentials</span>\n     <span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;aws-access-key-id>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"&lt;aws-secret-access-key>\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  services\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddTransient</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AwsSignatureHandler<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddTransient</span><span class=\"token punctuation\">(</span>_ <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AwsSignatureHandlerSettings</span><span class=\"token punctuation\">(</span>\n       <span class=\"token string\">\"&lt;aws-region>\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"execute-api\"</span><span class=\"token punctuation\">,</span> awsCredentials<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddDotNetifyIntegrationWebApi</span><span class=\"token punctuation\">(</span>client <span class=\"token operator\">=></span>\n       client<span class=\"token punctuation\">.</span>BaseAddress <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Uri</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;api-connection-url>/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddHttpMessageHandler</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>AwsSignatureHandler<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IApplicationBuilder</span> app<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">MapControllers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>DotNetify Client</h2>\n<p>Finally, the last and simplest setup step is to configure your dotNetify client to point to the WebSocket URL.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> dotnetify <span class=\"token keyword\">from</span> <span class=\"token string\">\"dotnetify\"</span>\n\ndotnetify<span class=\"token punctuation\">.</span>hub <span class=\"token operator\">=</span> dotnetify<span class=\"token punctuation\">.</span><span class=\"token function\">createWebSocketHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;aws-api-websocket-url>\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>And just like that, your dotNetify application server is now scalable and able to handle large-scale WebSocket connections.</p>\n<p>Of course, there may be some troubleshooting involved along the way, but don’t worry, it’s not too difficult to figure out. Just make sure to enable debug logging on the client and check the app server logs if you’re not seeing data being pushed to the client.</p>\n<p>In conclusion, using Amazon API Gateway to scale out your dotNetify application server is a great option that can save you a lot of time and effort and it’s not at all difficult to set up.</p>","frontmatter":{"title":"Scaling DotNetify Apps with AWS WebSockets","date":"March 06, 2023","description":"Use Amazon API Gateway and WebSocket API to scale your dotNetify app and handle large-scale WebSocket connections.","thumbnail":{"childImageSharp":{"fixed":{"src":"/dotNetify/static/4b37d772a8cd8fec5c3166dfc3ab1937/84873/thumbnail.png"},"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAADLUlEQVQozw2S71PadgDGv+QnJCHIbxUTEkgCSUCwCjGKUkAQxYpgQMVZC3ZgkdXOWdubbPVq7c7qqLve7bbu9mJv9mb/5HL3vHye55675wNCSklPVOPyKiXmJiMFZ3gZ989ZPQnYoaBkGOAsbGUga8CCjANswkqyAJkg7Txu5zCKB4qUX9OMim5IsVVerbgjeYyZt/pnUKcMkSGY4DF7GCVNaxDCJs0WyMbgFAfZWIBPgZi6tpqsdnMHncyONlfVZ+uTaongdMKfQJwR1CEiVBizmxUcbGNg65QFY2CSxx0iSghgOraxlNxKxzc6erObbRU1I7ewE02UXews5VcROozSAkpKEMbhlDmEQykJpWTMriKkCr6v9Hfm99fzh6m0UX/capXb1UyjmDVW8k15uqRlalxkiZdX5MS6y58c59K0P0VPaFbnNDY2A/7dv/hcffXf8OH+/ZeH+68frkbXw9uLb1//M/rr+ufR3ejvtz/dX17d//jubuXJs+5geHXz29XNQ7bcwt1J8HWz/2u593ltcFs/2y0PNrKdRvlo1Dz91Hj58uD8u/67Xnc4oxtyqirES66AJiiFgKB7g3O0VwVvC+3LYueX0vP+0rNmurWnfdPJtM/zR3vZw15vODi5POr8EIoUCO8j0jOD22MorcC0THljPiYJanrDmG8cZva2tcbx1smXD7//cfPnp9d3H89uX52+f3E8PB0M681jY69frbd3WifLpZaFlDxMysOnQUGrFVLVp3qjktndXO+c9C/fnF6398+PDt50n188bZ9t774wdntbRru6fbBZP1zI1gAWxCgJIWUgRUtStFiOrT9KVNRoMamWFXlDTdQUZdMfzJA+GRkTYVoEJlt4AFgmATQF2UIIESYcUeDmsryQE4V8VFmVpYIUe8LE66xa8UtZr6BRAQX1CrhbJD0RyitB5ufOKEaKKCnCpAAc7OIEv6yGH7PisjO0PBZacQlFBz+PBuKILwK7BdjJWwgTbwYiWdjOIUQQ4CYqAkxKYIxdpAO6KOYIZsE+rrnYhYCw6AjOQj7V6pNt3ghEc8DGmHlzNkyyCGUqhNGChQj9D5vmrZ+tulDkAAAAAElFTkSuQmCC","aspectRatio":1.4,"src":"/dotNetify/static/4b37d772a8cd8fec5c3166dfc3ab1937/196f1/thumbnail.png","srcSet":"/dotNetify/static/4b37d772a8cd8fec5c3166dfc3ab1937/6a57b/thumbnail.png 175w,\n/dotNetify/static/4b37d772a8cd8fec5c3166dfc3ab1937/e5c7d/thumbnail.png 350w,\n/dotNetify/static/4b37d772a8cd8fec5c3166dfc3ab1937/196f1/thumbnail.png 700w,\n/dotNetify/static/4b37d772a8cd8fec5c3166dfc3ab1937/77069/thumbnail.png 1024w","sizes":"(max-width: 700px) 100vw, 700px"}}}}},"previous":{"fields":{"slug":"/minimal-api/"},"frontmatter":{"title":"Introducing Minimal Real-Time API for .NET"}},"next":null},"pageContext":{"id":"b80f3eee-158c-5c89-95a0-a408f7b3e03d","previousPostId":"1cb4a6cf-09d3-524d-8552-02cb3bb471af","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}