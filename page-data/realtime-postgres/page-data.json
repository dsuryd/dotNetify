{"componentChunkName":"component---src-templates-blog-post-js","path":"/realtime-postgres/","result":{"data":{"site":{"siteMetadata":{"title":"dotNetify"}},"markdownRemark":{"id":"a5f69696-b160-5621-b1e9-ed146f02db0e","excerpt":"I was reading up on PostgreSQL when I noticed an interesting feature called logical replication. The documentation explains that logical replication is: “a…","html":"<p>I was reading up on PostgreSQL when I noticed an interesting feature called logical replication. The documentation explains that logical replication is:</p>\n<blockquote>\n<p>“a method of replicating data objects and their changes, based upon their replication identity (usually a primary key)“.</p>\n</blockquote>\n<p>In other words, it’s a way of ensuring copies of the database are always in sync by having the database publish logical data changes in real-time to subscriber nodes.</p>\n<p>A replication subscriber would typically be another database that is serving as a copy of the master, but it’s not limited to it and could be anything. What if we make that to be a web service? The service can then push those changes to multiple clients of a web application so they can always have their data synchronized in real-time.</p>\n<p>There’s actually another PostgreSQL feature, the NOTIFY command, that is intended to generate notifications, but we will need to write database triggers for each table we’re interested in, and the string payload size has a limit of 8000 bytes. Logical replication has no such limit and can listen to all tables in the database, which makes it more scalable.</p>\n<p>So I wrote a small open-source library that combines <a href=\"https://dotnetify.net\">dotNetify</a> with PostgreSQL logical replication. You can use it to build a web application with ASP.NET 5 that can react to all the inserts, updates, and deletes that any user of the app commits to a PostgreSQL database.</p>\n<p>With this library that I named <strong>DotNetify.Postgres</strong> (<a href=\"https://github.com/dsuryd/dotNetify/tree/master/DotNetifyLib.Postgres\">source code</a>), your project won’t involve polling the database, setting up a complicated pub/sub system, or take much code at all. The rest of the blog will take you through building a demo app.</p>\n<h2>PostgreSQL Setup</h2>\n<p>To enable logical replication in your PostgreSQL database, find the <em>postgresql.conf</em> configuration file, change the parameter <code class=\"language-text\">wal_level</code> to <em>logical</em>, and both <code class=\"language-text\">max_wal_senders</code> and <code class=\"language-text\">max_replication_slots</code> to at least 1. Changes will take effect after the service restarts.</p>\n<p>You can also change them with SQL commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> wal_level<span class=\"token operator\">=</span><span class=\"token string\">'logical'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> max_wal_senders<span class=\"token operator\">=</span><span class=\"token string\">'10'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> SYSTEM <span class=\"token keyword\">SET</span> max_replication_slots<span class=\"token operator\">=</span><span class=\"token string\">'10'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The next step is to create a publication:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> PUBLICATION my_pub <span class=\"token keyword\">FOR</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">TABLES</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We set it to publish data changes for all tables, but you can restrict it to just a specific table if you want.</p>\n<p>When PostgreSQL is publishing replication records (also known as <em>write-ahead logs</em> or WAL), it uses something called replication slots to ensure that the records do not get deleted until they’re received by the subscribers.</p>\n<p>Replication slots are great because they allow a subscriber to go temporarily offline and, on reconnect, to simply pick up where it left off. But there’s a caveat: the WAL records can pile up in a prolonged disconnection event, to the point that it can run out of space and crash the database, and therefore, the slots need to be monitored.</p>\n<p>Here’s how we create a replication slot:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> pg_create_logical_replication_slot<span class=\"token punctuation\">(</span><span class=\"token string\">'my_slot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pgoutput'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The <em>pgoutput</em> is PostgreSQL’s standard logical decoding plugin for transforming the changes from WAL to the logical replication protocol.</p>\n<p>For the demo, let’s create a simple table. We will also create a new user that will be used by our web service to connect to the database:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span> businesses <span class=\"token punctuation\">(</span>\n  business_id <span class=\"token keyword\">serial</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span><span class=\"token punctuation\">,</span>\n  business_name <span class=\"token keyword\">VARCHAR</span> <span class=\"token punctuation\">(</span> <span class=\"token number\">50</span> <span class=\"token punctuation\">)</span> <span class=\"token keyword\">UNIQUE</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  rating <span class=\"token keyword\">integer</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> my_user <span class=\"token keyword\">WITH</span> PASSWORD <span class=\"token string\">'my_pwd'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ALTER</span> ROLE my_user <span class=\"token keyword\">WITH</span> <span class=\"token keyword\">REPLICATION</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">PRIVILEGES</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">ALL</span> <span class=\"token keyword\">TABLES</span> <span class=\"token operator\">IN</span> <span class=\"token keyword\">SCHEMA</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">TO</span> my_user<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">GRANT</span> <span class=\"token keyword\">USAGE</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">ALL</span> SEQUENCES <span class=\"token operator\">IN</span> <span class=\"token keyword\">SCHEMA</span> <span class=\"token keyword\">public</span> <span class=\"token keyword\">TO</span> my_user<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Notice that we give the REPLICATION role to the user. Having this role is required for subscribing to replication slots.</p>\n<p>The Postgres database is now configured for logical replication. The next step is to create a web service to subscribe to the replication slot we’ve created and push the changes to the website.</p>\n<h2>Web Service Setup</h2>\n<p>You can download the source code from <a href=\"https://github.com/dsuryd/dotNetify/tree/master/Demo/React/RealtimeDb.Postgres\">this Github repo</a>. This is an ASP.NET project with a React/Typescript front-end and Webpack. After installing the npm packages, you can run the project from either Visual Studio or dotnet CLI.</p>\n<p>The code has an entity class for the demo table:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Table</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"businesses\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Business</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Column</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"business_id\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Key</span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">long</span></span> Id <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Column</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"business_name\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Column</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"rating\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> Rating <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There’s a simple React client to display the content of the table, and the associated <em>dotNetify</em> view model. The view model subscribes to the PostgreSQL data change events on the table through an API that the <strong>DotNetify.Postgres</strong> library provides, and pushes state updates to the client in real-time:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">  <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BusinessesVM</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">BaseVM</span></span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IDisposable</span> _subs<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Real-time list; see: https://dotnetify.net/core/api/crud.</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">ItemKey</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>Business<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">List<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span> Businesses <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">BusinessesVM</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IDbChangeObserver</span> dbChangeObserver<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Businesses <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        _subs <span class=\"token operator\">=</span> dbChangeObserver\n          <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Observe</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">Subscribe</span><span class=\"token punctuation\">(</span>e <span class=\"token operator\">=></span>\n          <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">is</span> <span class=\"token class-name\">DbInsertEvent<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> row <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">as</span> <span class=\"token class-name\">DbInsertEvent<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Row<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">AddList</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>Businesses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n              <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">is</span> <span class=\"token class-name\">DbUpdateEvent<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> row <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">as</span> <span class=\"token class-name\">DbUpdateEvent<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>NewRow<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">UpdateList</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>Businesses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n              <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">is</span> <span class=\"token class-name\">DbDeleteEvent<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> key <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e <span class=\"token keyword\">as</span> <span class=\"token class-name\">DbDeleteEvent<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Row<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">RemoveList</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>Businesses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n              <span class=\"token function\">PushUpdates</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> _subs<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The connection string to our PostgreSQL database along with the publication and replication slot names are configured in the service startup class:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddSignalR</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddDotNetify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddDotNetifyPostgres</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PostgresConfiguration</span>\n    <span class=\"token punctuation\">{</span>\n      ConnectionString <span class=\"token operator\">=</span> Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Postgres\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      PublicationName <span class=\"token operator\">=</span> <span class=\"token string\">\"my_pub\"</span><span class=\"token punctuation\">,</span>\n      ReplicationSlotName <span class=\"token operator\">=</span> <span class=\"token string\">\"my_slot\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And that’s all there is to it! Here’s how the app’s reacting to data changes:</p>\n<img src=\"/dotNetify/d2ccf054aba6bab3feb984963f2c2909/listen-only.gif\" width=\"630px\">\n<h2>Full CRUD with EF Core</h2>\n<p>So far we have a web page that’s only reacting to data changes on the database. Let’s take it a step further and make it capable of CRUD operations as well. For this, we’re going to use EF Core with the <a href=\"https://www.npgsql.org/\">Npgsql</a> library.</p>\n<p>Let’s add a <code class=\"language-text\">DbContext</code> class for our demo table:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BusinessDbContext</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">DbContext</span></span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">DbSet<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span> Businesses <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token function\">BusinessDbContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DbContextOptions<span class=\"token punctuation\">&lt;</span>BusinessDbContext<span class=\"token punctuation\">></span></span> options<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">:</span> <span class=\"token keyword\">base</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>DotNetify view models must use a factory to create a new <code class=\"language-text\">DbContext</code> because of the long lifetimes. So we configure the <code class=\"language-text\">DbContextFactory</code> service in the startup class:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n  services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddDbContextFactory</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>BusinessDbContext<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">=></span>\n    options<span class=\"token punctuation\">.</span><span class=\"token function\">UseNpgsql</span><span class=\"token punctuation\">(</span>Configuration<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Postgres\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The last step is implementing CRUD methods on the view model:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BusinessesVM</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">BaseVM</span></span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IDbContextFactory<span class=\"token punctuation\">&lt;</span>BusinessDbContext<span class=\"token punctuation\">></span></span> _contextFactory<span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">ItemKey</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>Business<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">List<span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span> Businesses <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token function\">BusinessesVM</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">IDbContextFactory<span class=\"token punctuation\">&lt;</span>BusinessDbContext<span class=\"token punctuation\">></span></span> dbContextFactory<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">IDbChangeObserver</span> dbChangeObserver<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      _contextFactory <span class=\"token operator\">=</span> dbContextFactory<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dbContext <span class=\"token operator\">=</span> _contextFactory<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDbContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      Businesses <span class=\"token operator\">=</span> dbContext<span class=\"token punctuation\">.</span>Businesses<span class=\"token punctuation\">.</span><span class=\"token function\">OrderBy</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">ObserveList</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Business<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>Businesses<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dbChangeObserver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Business</span> businessInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dbContext <span class=\"token operator\">=</span> _contextFactory<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDbContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      dbContext<span class=\"token punctuation\">.</span>Businesses<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>businessInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      dbContext<span class=\"token punctuation\">.</span><span class=\"token function\">SaveChanges</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Update</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Business</span> businessInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dbContext <span class=\"token operator\">=</span> _contextFactory<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDbContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> business <span class=\"token operator\">=</span> dbContext<span class=\"token punctuation\">.</span>Businesses<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span>businessInfo<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>business <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">{</span>\n        business<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">=</span> businessInfo<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">;</span>\n        business<span class=\"token punctuation\">.</span>Rating <span class=\"token operator\">=</span> businessInfo<span class=\"token punctuation\">.</span>Rating<span class=\"token punctuation\">;</span>\n        dbContext<span class=\"token punctuation\">.</span><span class=\"token function\">SaveChanges</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Business</span> businessInfo<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dbContext <span class=\"token operator\">=</span> _contextFactory<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDbContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> business <span class=\"token operator\">=</span> dbContext<span class=\"token punctuation\">.</span>Businesses<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span>businessInfo<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>business <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">{</span>\n        dbContext<span class=\"token punctuation\">.</span>Businesses<span class=\"token punctuation\">.</span><span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span>business<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        dbContext<span class=\"token punctuation\">.</span><span class=\"token function\">SaveChanges</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you may notice, the previous code that does the subscription and data change event handling are simplified into a single call to the <em>ObserveList</em> extension method.</p>\n<p>Here’s an excerpt of the React client that invokes those CRUD methods:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">Businesses</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> vm<span class=\"token punctuation\">,</span> state <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> useConnect<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">(\"BusinessesVM\");\n  const [newName, setNewName] = useState</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>string</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">(\"\");\n\n  const addBusiness = (name: string) => </span><span class=\"token punctuation\">{</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token function\">$dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Add<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Business</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setNewName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token plain-text\">;\n\n  const updateBusiness = (id: number, name: string, rating: number) => </span><span class=\"token punctuation\">{</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token function\">$dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Update<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Business</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> rating<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token plain-text\">;\n\n  const removeBusiness = (id: number) => </span><span class=\"token punctuation\">{</span>\n    vm<span class=\"token punctuation\">.</span><span class=\"token function\">$dispatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Remove<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Business</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token plain-text\">;\n...</span></code></pre></div>\n<p>And with that, here’s the demo of two browser instances of the app keeping in sync with each other while we apply some CRUD operations:</p>\n<img src=\"/dotNetify/5afa375942305b93aa56fc9bdb2ec18a/businesses-crud.gif\" width=\"630px\">\n<h2></h2>\n<p>I hope this is useful to you! I’d be interested to hear what you think. Reply to <a href=\"https://twitter.com/dotnetify/status/1422453418581389315\">my tweet</a> and let me know. And feel free to retweet!</p>","frontmatter":{"title":"Real-time Web Updates From Your PostgreSQL Database","date":"August 03, 2021","description":"Combine PostgreSQL logical replication feature with dotNetify to broadcast data changes to your website in real-time.","thumbnail":{"childImageSharp":{"fixed":{"src":"/dotNetify/static/41440d0b5d76143b7e281fe64fa79404/e4025/dotnetify-postgres.png"},"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACNElEQVQ4y61TS08TURSev+LWjbp0hVtj4sLoQuPCEMLGRI0xKHHjI5VH0qJG06F2KkZgtKQoBG2HdmglmmkJtUjUwEwhY4vJIG1JrRRaZ+ZzHn1My7gw8SQn59ybe8797rnfR+AfTFXVRrRz3YjmIQWKKhsRar1YbWlSj4qiQNZcUVQjGvua6/uE9bAVifXWRq5HO+RyVev2uxVhfkfEB9EN7psHu3KhtVHNlFoeib3HoOcF6NdBuHx+eF/OoF9bcwuLJsLS3iY+S9Ng0/1YzI4hEp7HKs83G2lP2ynvGXlGXMfp649wuPsBzjvGceBsHzqukDhzh8a5HicIWYMqbLGIrbmQyFIo5IsIR1iw0Ri2cjmjiSBKiMa/QJ8Wv7KCU73DOHbVg6GJeZy8OaK5D3fHYrjoGAaxWy0iuaGh4u8huj6AwnYBT589R5idg5BOY/tnGcF3SwgwCSyvbqBa/oWuW24cvUTiwoAfJ3opHL9Bocc9jakQC0LREebmEBYcWJYmkC9KYGZZcPEEJGnTQPhDQ536KjZGQI5OouPyY/T5ptA56MfBTheGxhl4KcqcoU6Xpe8BpDKvMBl4g7ehEHhBsPl9kyKZbBbkCA2P14dr92kc6n4I5xMaHBdv/rLOB55fQ5BhkEymUKlU9pO4jWJqpYzbpB9HupyYZaMmbRpFNgyzU0aT3Ga+8PETRgMzKJVK7UoxC5SaEvaRuu0Cq4qsAIi/6dNOQe1KqnNUtgAg8J/tD8ieAWIyBezWAAAAAElFTkSuQmCC","aspectRatio":1.4,"src":"/dotNetify/static/41440d0b5d76143b7e281fe64fa79404/196f1/dotnetify-postgres.png","srcSet":"/dotNetify/static/41440d0b5d76143b7e281fe64fa79404/6a57b/dotnetify-postgres.png 175w,\n/dotNetify/static/41440d0b5d76143b7e281fe64fa79404/e5c7d/dotnetify-postgres.png 350w,\n/dotNetify/static/41440d0b5d76143b7e281fe64fa79404/196f1/dotnetify-postgres.png 700w,\n/dotNetify/static/41440d0b5d76143b7e281fe64fa79404/ff28a/dotnetify-postgres.png 707w","sizes":"(max-width: 700px) 100vw, 700px"}}}}},"previous":{"fields":{"slug":"/scale-out/"},"frontmatter":{"title":"Recreating \"Azure SignalR\" Scale-Out"}},"next":{"fields":{"slug":"/minimal-api/"},"frontmatter":{"title":"Introducing Minimal Real-Time API for .NET"}}},"pageContext":{"id":"a5f69696-b160-5621-b1e9-ed146f02db0e","previousPostId":"c0d6e475-216a-549f-b08a-92f269890062","nextPostId":"1cb4a6cf-09d3-524d-8552-02cb3bb471af"}},"staticQueryHashes":["2841359383","3257411868"]}